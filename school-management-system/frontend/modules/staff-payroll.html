<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff & Payroll Module - School Manager System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/modules/staff-payroll.css">
    <link id="theme-css" rel="stylesheet" href="../css/themes/light-theme.css">
    <script src="../js/global-theme-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.1.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../js/auth-manager.js"></script>
    <script src="../js/api-client.js"></script>
    <script src="../js/global-navigation.js"></script>
    <script src="../js/modules/staff-payroll-core.js"></script>
    <script src="../js/modules/staff-payroll-functions.js"></script>

</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="sidebar-header">
                <h2>
                    <i class="fas fa-graduation-cap"></i>
                    <span>School Manager</span>
                </h2>
            </div>
            <div class="admin-profile">
                <div class="admin-avatar">A</div>
                <div class="admin-info">
                    <h4>Admin User</h4>
                    <p>Administrator</p>
                </div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">Main Navigation</div>
                    <a href="../index.html" class="menu-item" onclick="navigateToPage('../index.html')">
                        <i class="fas fa-home"></i>
                        <span data-translate="dashboard">Dashboard</span>
                    </a>
                    <a href="./student-module.html" class="menu-item" onclick="navigateToPage('./student-module.html')">
                        <i class="fas fa-users"></i>
                        <span data-translate="students">Students</span>
                    </a>
                    <a href="./fees-payment.html" class="menu-item" onclick="navigateToPage('./fees-payment.html')">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-translate="fees_payments">Fees & Payments</span>
                    </a>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">Management</div>
                    <a href="./staff-payroll.html" class="menu-item active">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span data-translate="staff_payroll">Staff & Payroll</span>
                    </a>
                    <a href="./procurement.html" class="menu-item" onclick="navigateToPage('./procurement.html')">
                        <i class="fas fa-shopping-cart"></i>
                        <span data-translate="procurement">Procurement</span>
                    </a>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">System</div>
                    <a href="reports.html" class="menu-item" onclick="navigateToModule('reports.html')">
                        <i class="fas fa-chart-bar"></i>
                        <span data-translate="reports">Reports</span>
                    </a>
                    <a href="settings.html" class="menu-item" onclick="navigateToModule('settings.html')">
                        <i class="fas fa-cog"></i>
                        <span data-translate="settings">Settings</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1><i class="fas fa-chalkboard-teacher"></i><span data-translate="staff_payroll_module"> Staff & Payroll Module</span></h1>
                </div>
                <div class="header-right">
                    <button class="language-toggle" onclick="toggleLanguage()">
                        <i class="fas fa-language"></i>
                        <span id="language-text">EN</span>
                    </button>
                    <div class="current-time">
                        <i class="fas fa-clock"></i>
                        <span id="current-time">Loading...</span>
                    </div>
                    <div class="user-profile" onclick="openModal('userProfileModal')">
                        <img id="userProfileImage" class="user-avatar" src="" alt="Profile" style="display: none; width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="userName">Admin</span>
                    </div>
                    <button class="btn btn-danger" onclick="openModal('logoutModal')">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-translate="logout">Logout</span>
                    </button>
                </div>
            </div>

            <!-- Cards Summary -->
            <div class="content">
                <div class="dashboard-cards">
                    <div class="card" onclick="applyQuickFilter('all')">
                        <div class="card-header">
                            <div class="card-title" data-translate="total_staff">Total Staff</div>
                            <div class="card-icon total"><i class="fas fa-users"></i></div>
                        </div>
                        <div class="card-body">
                            <div class="card-value" id="cardTotalStaff">0</div>
                            <div class="card-description" data-translate="all_employees">All employees in the system</div>
                        </div>
                    </div>
                    <div class="card" onclick="applyQuickFilter('active')">
                        <div class="card-header">
                            <div class="card-title" data-translate="active_staff">Active Staff</div>
                            <div class="card-icon active"><i class="fas fa-user-check"></i></div>
                        </div>
                        <div class="card-body">
                            <div class="card-value" id="cardActiveStaff">0</div>
                            <div class="card-description" data-translate="currently_employed">Currently employed staff</div>
                        </div>
                    </div>
                    <div class="card" onclick="applyQuickFilter('inactive')">
                        <div class="card-header">
                            <div class="card-title" data-translate="inactive_staff">On Leave</div>
                            <div class="card-icon inactive"><i class="fas fa-user-clock"></i></div>
                        </div>
                        <div class="card-body">
                            <div class="card-value" id="cardInactiveStaff">0</div>
                            <div class="card-description" data-translate="staff_on_leave">Staff currently on leave</div>
                        </div>
                    </div>
                    <div class="card" onclick="showPayrollSummary()">
                        <div class="card-header">
                            <div class="card-title" data-translate="monthly_payroll">Monthly Payroll</div>
                            <div class="card-icon payroll"><i class="fas fa-money-bill-wave"></i></div>
                        </div>
                        <div class="card-body">
                            <div class="card-value" id="cardMonthlyPayroll">TZS 0</div>
                            <div class="card-description" data-translate="total_monthly_salaries">Total monthly salaries</div>
                        </div>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openModal('staffModal')"><i class="fas fa-plus"></i><span data-translate="add_staff">Add Staff</span></button>
                    <button class="btn btn-success" onclick="processPayroll()"><i class="fas fa-calculator"></i><span data-translate="process_payroll">Process Payroll</span></button>
                    <input id="fileImport" class="hidden" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="handleImport(event)">
                    <button class="btn btn-outline" onclick="document.getElementById('fileImport').click()"><i class="fas fa-file-import"></i><span data-translate="import">Import</span></button>
                    <button class="btn btn-outline" onclick="exportCSV()"><i class="fas fa-file-csv"></i>CSV</button>
                    <button class="btn btn-outline" onclick="exportXLSX()"><i class="fas fa-file-excel"></i>Excel</button>
                    <button class="btn btn-outline" onclick="exportPDF()"><i class="fas fa-file-pdf"></i>PDF</button>
                    <button class="btn btn-warning" onclick="printPayslipsBulk()"><i class="fas fa-print"></i><span data-translate="print_payslips">Print Payslips</span></button>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <select id="filterDepartment" class="form-control w-160" onchange="renderTable()">
                        <option value="">All Departments</option>
                        <option>Teaching</option>
                        <option>Administration</option>
                        <option>Support</option>
                        <option>Management</option>
                    </select>
                    <select id="filterStatus" class="form-control w-160" onchange="renderTable()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">On Leave</option>
                        <option value="terminated">Terminated</option>
                    </select>
                    <input id="searchInput" class="form-control" style="flex:1;" placeholder="Search by name or employee ID" oninput="renderTable()">
                </div>

                <!-- Table -->
                <div class="table-wrap">
                    <table id="staffTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                                <th>Employee ID</th>
                                <th>Full Name</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Salary (TZS)</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Add/Edit Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="staffModalTitle">Add New Staff</h3>
                <button class="modal-close" onclick="closeModal('staffModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Staff Number *</label>
                            <input type="text" id="staffNo" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Position *</label>
                            <select id="position" class="form-control" required>
                                <option value="">Select Position</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Head Teacher">Head Teacher</option>
                                <option value="Deputy Head">Deputy Head</option>
                                <option value="Secretary">Secretary</option>
                                <option value="Accountant">Accountant</option>
                                <option value="Librarian">Librarian</option>
                                <option value="Security Guard">Security Guard</option>
                                <option value="Cleaner">Cleaner</option>
                                <option value="Cook">Cook</option>
                                <option value="Driver">Driver</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department *</label>
                            <select id="department" class="form-control" required>
                                <option value="">Select Department</option>
                                <option value="Teaching">Teaching</option>
                                <option value="Administration">Administration</option>
                                <option value="Support">Support</option>
                                <option value="Management">Management</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subjects (for Teachers)</label>
                            <select id="subjects" class="form-control" multiple>
                                <option value="Mathematics">Mathematics</option>
                                <option value="English">English</option>
                                <option value="Kiswahili">Kiswahili</option>
                                <option value="Science">Science</option>
                                <option value="Geography">Geography</option>
                                <option value="History">History</option>
                                <option value="Civics">Civics</option>
                                <option value="Biology">Biology</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Physics">Physics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Classes (for Teachers)</label>
                            <select id="classes" class="form-control" multiple>
                                <option value="Form1A">Form 1A</option>
                                <option value="Form1B">Form 1B</option>
                                <option value="Form2A">Form 2A</option>
                                <option value="Form2B">Form 2B</option>
                                <option value="Form3A">Form 3A</option>
                                <option value="Form3B">Form 3B</option>
                                <option value="Form4A">Form 4A</option>
                                <option value="Form4B">Form 4B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employment Type *</label>
                            <select id="employmentType" class="form-control" required>
                                <option value="Permanent">Permanent</option>
                                <option value="Contract">Contract</option>
                                <option value="Hourly">Hourly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Salary Type *</label>
                            <select id="salaryType" class="form-control" required>
                                <option value="Monthly">Monthly</option>
                                <option value="Hourly">Hourly</option>
                                <option value="Contract">Contract</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base Salary (TZS) *</label>
                            <input type="number" id="baseSalary" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number *</label>
                            <input type="tel" id="phoneNumber" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">National ID *</label>
                            <input type="text" id="nationalId" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" id="bankName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Account</label>
                            <input type="text" id="bankAccount" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Employment *</label>
                            <input type="date" id="dateOfEmployment" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select id="status" class="form-control" required>
                                <option value="active">Active</option>
                                <option value="inactive">On Leave</option>
                                <option value="terminated">Terminated</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="address" class="form-control" rows="2"></textarea>
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('staffModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">Save Staff</button>
            </div>
        </div>
    </div>

    <!-- Payroll Run Modal -->
    <div id="payrollModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Payroll Run</h3>
                <button class="modal-close" onclick="closeModal('payrollModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Run Name *</label>
                        <input type="text" id="payrollRunName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Period Start *</label>
                        <input type="date" id="periodStart" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Period End *</label>
                        <input type="date" id="periodEnd" class="form-control" required>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="calculatePayroll()">Calculate Payroll</button>
                    <button class="btn btn-success" onclick="processPayrollRun()">Process Run</button>
                    <button class="btn btn-warning" onclick="markSelectedAsPaid()">Mark Selected as Paid</button>
                </div>
                <div class="table-wrap">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onclick="toggleSelectAllPayroll(this)"></th>
                                <th>Staff</th>
                                <th>Base Salary</th>
                                <th>Allowances</th>
                                <th>Gross</th>
                                <th>Deductions</th>
                                <th>Net Pay</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Payslip Modal -->
    <div id="payslipModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Payslip</h3>
                <button class="modal-close" onclick="closeModal('payslipModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="payslipContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('payslipModal')">Close</button>
                <button class="btn btn-primary" onclick="downloadPayslipPDF()">Download PDF</button>
                <button class="btn btn-success" onclick="printPayslip()">Print</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Staff Data</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select CSV/Excel File</label>
                    <input type="file" id="importFile" class="form-control" accept=".csv,.xlsx,.xls">
                </div>
                <div id="importPreview" style="display: none;">
                    <h4>Preview Data:</h4>
                    <div class="table-wrap">
                        <table id="previewTable">
                            <thead id="previewTableHead"></thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('importModal')">Cancel</button>
                <button class="btn btn-primary" onclick="previewImport()">Preview</button>
                <button class="btn btn-success" onclick="confirmImport()" style="display: none;" id="confirmImportBtn">Import Data</button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Logout</h3>
                <button class="modal-close" onclick="closeModal('logoutModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to logout?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('logoutModal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div id="chartsSection" style="display: none; margin-top: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Payroll by Department</div>
                </div>
                <div class="card-body">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Payment Status</div>
                </div>
                <div class="card-body">
                    <canvas id="paymentStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let staffData = [];
        let payrollRuns = [];
        let currentEditingStaff = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            renderTable();
            updateCards();
            updateTime();
            setInterval(updateTime, 1000);
        });

        function loadSampleData() {
            staffData = [
                {
                    id: 1, staffNo: 'STF001', fullName: 'John Kamau', position: 'Teacher', 
                    department: 'Teaching', subjects: ['Mathematics', 'Physics'], 
                    classes: ['Form3A', 'Form4A'], employmentType: 'Permanent',
                    salaryType: 'Monthly', baseSalary: 800000, phoneNumber: '0754123456',
                    email: 'john.kamau@school.co.tz', nationalId: '19850615-12345-67890-12',
                    bankName: 'CRDB Bank', bankAccount: '****6789', dateOfEmployment: '2020-01-15',
                    status: 'active', address: 'Dar es Salaam, Tanzania',
                    allowances: [{name: 'Transport', amount: 50000}, {name: 'Housing', amount: 100000}],
                    deductions: [{name: 'Pension', amount: 40000}, {name: 'Tax', amount: 80000}]
                },
                {
                    id: 2, staffNo: 'STF002', fullName: 'Mary Mwalimu', position: 'Head Teacher',
                    department: 'Management', subjects: ['English', 'Kiswahili'],
                    classes: ['Form1A', 'Form2A'], employmentType: 'Permanent',
                    salaryType: 'Monthly', baseSalary: 1200000, phoneNumber: '0765987654',
                    email: 'mary.mwalimu@school.co.tz', nationalId: '19800312-98765-43210-98',
                    bankName: 'NMB Bank', bankAccount: '****4321', dateOfEmployment: '2018-08-01',
                    status: 'active', address: 'Arusha, Tanzania',
                    allowances: [{name: 'Transport', amount: 80000}, {name: 'Housing', amount: 150000}],
                    deductions: [{name: 'Pension', amount: 60000}, {name: 'Tax', amount: 120000}]
                }
            ];
        }

        // Modal Functions
        function openModal(modalId) { document.getElementById(modalId).classList.add('show'); }
        function closeModal(modalId) { 
            document.getElementById(modalId).classList.remove('show');
            if (modalId === 'staffModal') resetStaffForm();
        }

        function resetStaffForm() {
            document.getElementById('staffForm').reset();
            currentEditingStaff = null;
            document.getElementById('staffModalTitle').textContent = 'Add New Staff';
        }

        // Staff CRUD
        function editStaff(id) {
            const staff = staffData.find(function(s) { return s.id === id; });
            if (!staff) return;
            currentEditingStaff = staff;
            
            // Populate form
            document.getElementById('staffNo').value = staff.staffNo;
            document.getElementById('fullName').value = staff.fullName;
            document.getElementById('position').value = staff.position;
            document.getElementById('department').value = staff.department;
            document.getElementById('baseSalary').value = staff.baseSalary;
            document.getElementById('phoneNumber').value = staff.phoneNumber;
            document.getElementById('email').value = staff.email || '';
            document.getElementById('nationalId').value = staff.nationalId;
            document.getElementById('status').value = staff.status;
            
            openModal('staffModal');
        }

        function saveStaff() {
            const form = document.getElementById('staffForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }

            const staffItem = {
                id: currentEditingStaff ? currentEditingStaff.id : Date.now(),
                staffNo: document.getElementById('staffNo').value,
                fullName: document.getElementById('fullName').value,
                position: document.getElementById('position').value,
                department: document.getElementById('department').value,
                baseSalary: parseFloat(document.getElementById('baseSalary').value),
                phoneNumber: document.getElementById('phoneNumber').value,
                email: document.getElementById('email').value,
                nationalId: document.getElementById('nationalId').value,
                status: document.getElementById('status').value,
                allowances: [],
                deductions: []
            };

            if (currentEditingStaff) {
                const index = staffData.findIndex(function(s) { return s.id === currentEditingStaff.id; });
                staffData[index] = staffItem;
                showNotification('Staff updated successfully!', 'success');
            } else {
                staffData.push(staffItem);
                showNotification('Staff added successfully!', 'success');
            }

            closeModal('staffModal');
            renderTable();
            updateCards();
        }

        function deleteStaff(id) {
            if (confirm('Are you sure you want to delete this staff member?')) {
                staffData = staffData.filter(function(s) { return s.id !== id; });
                renderTable();
                updateCards();
                showNotification('Staff deleted successfully!', 'success');
            }
        }

        function viewStaff(id) {
            const staff = staffData.find(function(s) { return s.id === id; });
            if (staff) {
                alert(`Staff Details:\nName: ${staff.fullName}\nPosition: ${staff.position}\nDepartment: ${staff.department}\nSalary: ${formatCurrency(staff.baseSalary)}`);
            }
        }

        // Table Rendering
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('filterDepartment').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filteredData = staffData.filter(function(staff) {
                const matchesSearch = staff.fullName.toLowerCase().includes(searchTerm) || 
                                    staff.staffNo.toLowerCase().includes(searchTerm);
                const matchesDepartment = !departmentFilter || staff.department === departmentFilter;
                const matchesStatus = !statusFilter || staff.status === statusFilter;
                return matchesSearch && matchesDepartment && matchesStatus;
            });

            tbody.innerHTML = filteredData.map(function(staff) {
                return `
                    <tr>
                        <td><input type="checkbox" class="staff-checkbox" value="${staff.id}"></td>
                        <td>${staff.staffNo}</td>
                        <td>${staff.fullName}</td>
                        <td>${staff.department}</td>
                        <td>${staff.position}</td>
                        <td>${formatCurrency(staff.baseSalary)}</td>
                        <td><span class="status-badge status-${staff.status}">${capitalizeFirst(staff.status)}</span></td>
                        <td>
                            <div class="row-actions">
                                <button class="btn btn-outline" onclick="viewStaff(${staff.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline" onclick="editStaff(${staff.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline" onclick="generatePayslip(${staff.id})" title="Payslip">
                                    <i class="fas fa-receipt"></i>
                                </button>
                                <button class="btn btn-outline" onclick="deleteStaff(${staff.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Payroll Functions
        function processPayroll() {
            openModal('payrollModal');
            calculatePayroll();
        }

        function calculatePayroll() {
            const tbody = document.getElementById('payrollTableBody');
            const activeStaff = staffData.filter(function(s) { return s.status === 'active'; });
            
            tbody.innerHTML = activeStaff.map(function(staff) {
                const allowancesTotal = (staff.allowances || []).reduce(function(sum, a) { return sum + a.amount; }, 0);
                const deductionsTotal = (staff.deductions || []).reduce(function(sum, d) { return sum + d.amount; }, 0);
                const gross = staff.baseSalary + allowancesTotal;
                const net = gross - deductionsTotal;
                
                return `
                    <tr>
                        <td><input type="checkbox" class="payroll-checkbox" value="${staff.id}"></td>
                        <td>${staff.fullName}</td>
                        <td>${formatCurrency(staff.baseSalary)}</td>
                        <td>${formatCurrency(allowancesTotal)}</td>
                        <td>${formatCurrency(gross)}</td>
                        <td>${formatCurrency(deductionsTotal)}</td>
                        <td>${formatCurrency(net)}</td>
                        <td><span class="status-badge status-active">Pending</span></td>
                        <td>
                            <button class="btn btn-success" onclick="markAsPaid(${staff.id})">
                                <i class="fas fa-check"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function markAsPaid(staffId) {
            showNotification('Payment recorded successfully!', 'success');
        }

        function generatePayslip(staffId) {
            const staff = staffData.find(function(s) { return s.id === staffId; });
            if (!staff) return;
            
            const allowancesTotal = (staff.allowances || []).reduce(function(sum, a) { return sum + a.amount; }, 0);
            const deductionsTotal = (staff.deductions || []).reduce(function(sum, d) { return sum + d.amount; }, 0);
            const gross = staff.baseSalary + allowancesTotal;
            const net = gross - deductionsTotal;
            
            const payslipHTML = `
                <div style="padding: 20px; font-family: Arial, sans-serif;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2>SCHOOL MANAGEMENT SYSTEM</h2>
                        <h3>PAYSLIP - ${new Date().toLocaleDateString('en-US', {month: 'long', year: 'numeric'})}</h3>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <strong>Employee Information:</strong><br>
                        Staff No: ${staff.staffNo}<br>
                        Name: ${staff.fullName}<br>
                        Position: ${staff.position}<br>
                        Department: ${staff.department}
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px;">EARNINGS</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">AMOUNT (TZS)</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;">Base Salary</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(staff.baseSalary)}</td>
                        </tr>
                        <tr style="background: #e9ecef; font-weight: bold;">
                            <td style="border: 1px solid #ddd; padding: 8px;">NET PAY</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(net)}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            document.getElementById('payslipContent').innerHTML = payslipHTML;
            openModal('payslipModal');
        }

        function printPayslip() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Payslip</title></head>
                    <body>${document.getElementById('payslipContent').innerHTML}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-TZ', {
                style: 'currency',
                currency: 'TZS',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function updateCards() {
            const totalStaff = staffData.length;
            const activeStaff = staffData.filter(function(s) { return s.status === 'active'; }).length;
            const inactiveStaff = staffData.filter(function(s) { return s.status === 'inactive'; }).length;
            const totalPayroll = staffData.filter(function(s) { return s.status === 'active'; })
                .reduce(function(sum, s) { return sum + s.baseSalary; }, 0);

            document.getElementById('cardTotalStaff').textContent = totalStaff;
            document.getElementById('cardActiveStaff').textContent = activeStaff;
            document.getElementById('cardInactiveStaff').textContent = inactiveStaff;
            document.getElementById('cardMonthlyPayroll').textContent = formatCurrency(totalPayroll);
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(function() {
                notification.remove();
            }, 3000);
        }

        // Export Functions
        function exportCSV() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Staff No,Full Name,Position,Department,Salary,Status\n" +
                staffData.map(function(staff) {
                    return `${staff.staffNo},${staff.fullName},${staff.position},${staff.department},${staff.baseSalary},${staff.status}`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "staff_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportXLSX() {
            showNotification('Excel export functionality would be implemented here', 'success');
        }

        function exportPDF() {
            showNotification('PDF export functionality would be implemented here', 'success');
        }

        // Filter Functions
        function applyQuickFilter(filter) {
            const statusFilter = document.getElementById('filterStatus');
            switch(filter) {
                case 'active':
                    statusFilter.value = 'active';
                    break;
                case 'inactive':
                    statusFilter.value = 'inactive';
                    break;
                default:
                    statusFilter.value = '';
            }
            renderTable();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.staff-checkbox');
            checkboxes.forEach(function(cb) { cb.checked = checkbox.checked; });
        }

        function toggleSelectAllPayroll(checkbox) {
            const checkboxes = document.querySelectorAll('.payroll-checkbox');
            checkboxes.forEach(function(cb) { cb.checked = checkbox.checked; });
        }

        // Sidebar Functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
        }

        function toggleLanguage() {
            const currentLanguage = document.getElementById('language-text').textContent === 'EN' ? 'SW' : 'EN';
            document.getElementById('language-text').textContent = currentLanguage;
        }

        // Import Functions
        function handleImport(event) {
            openModal('importModal');
        }

        function previewImport() {
            showNotification('Import preview functionality would be implemented here', 'success');
        }

        function confirmImport() {
            showNotification('Import confirmation functionality would be implemented here', 'success');
        }

        function printPayslipsBulk() {
            showNotification('Bulk payslip printing functionality would be implemented here', 'success');
        }

        function downloadPayslipPDF() {
            showNotification('PDF download functionality would be implemented here', 'success');
        }

        function showPayrollSummary() {
            showNotification('Payroll summary functionality would be implemented here', 'success');
        }

        // Logout function
        function logout() {
            closeModal('logoutModal');
            if (window.authManager) {
                window.authManager.logout();
            } else {
                // Fallback if authManager not available
                localStorage.removeItem('sms_session');
                localStorage.removeItem('sms_user');
                window.location.href = '../login.html';
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    </script>
</body>
</html>
