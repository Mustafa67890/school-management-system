<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/modules/dashboard.css">
    <link rel="stylesheet" href="css/performance-styles.css">
    <link id="theme-css" rel="stylesheet" href="css/themes/light-theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/global-theme-manager.js"></script>
    <script src="js/global-navigation.js"></script>
    
    <style>
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex !important;
        }
        
        /* Summary Cards Styles */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 0;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }
        
        .summary-card .card-icon.students { background: var(--info); }
        .summary-card .card-icon.fees { background: var(--success); }
        .summary-card .card-icon.payroll { background: var(--warning); }
        .summary-card .card-icon.procurement { background: var(--danger); }
        
        .summary-card .card-content {
            flex: 1;
        }
        
        .summary-card .card-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .summary-card .card-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .summary-card .card-description {
            font-size: 14px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .summary-card .card-description.positive {
            color: #28a745;
        }
        
        .summary-card .card-description.negative {
            color: #dc3545;
        }
        
        /* Quick Actions Styles */
        .quick-actions {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .quick-actions h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
        }
        
        .action-btn i {
            font-size: 16px;
        }
        
        /* Recent Activity Styles */
        .recent-activity {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .activity-icon.payment { background: var(--success); }
        .activity-icon.salary { background: var(--warning); }
        .activity-icon.purchase { background: var(--danger); }
        .activity-icon.student { background: var(--info); }
        .activity-icon.staff { background: var(--secondary); }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .summary-card {
                padding: 15px;
            }
            
            .summary-card .card-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .summary-card .card-value {
                font-size: 24px;
            }
            
            .quick-actions, .recent-activity {
                padding: 20px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .summary-card {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .summary-card .card-content h3 {
                font-size: 14px;
            }
            
            .summary-card .card-value {
                font-size: 20px;
            }
            
            .activity-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .activity-icon {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }
        
        /* Animation improvements */
        .summary-card, .action-btn, .activity-item {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Analytics Chart Styles */
        .analytics-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .chart-container.hidden {
            height: 0;
            overflow: hidden;
            margin-top: 0;
        }
        
        #dashboardChart {
            max-width: 100%;
            height: auto;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }
        
        .section-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="sidebar-header">
                <h2>
                    <i class="fas fa-graduation-cap"></i>
                    <span>School Manager</span>
                </h2>
            </div>
            
            <div class="admin-profile">
                <div class="admin-avatar">A</div>
                <div class="admin-info">
                    <h4>Admin User</h4>
                    <p>Administrator</p>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-section">
                    <div class="menu-section-title">Main Navigation</div>
                    <a href="./index.html" class="menu-item active">
                        <i class="fas fa-home"></i>
                        <span data-translate="dashboard">Dashboard</span>
                    </a>
                    <a href="./modules/student-module.html" class="menu-item" onclick="navigateToPage('./modules/student-module.html')">
                        <i class="fas fa-users"></i>
                        <span data-translate="students">Students</span>
                    </a>
                    <a href="./modules/fees-payment.html" class="menu-item" onclick="navigateToPage('./modules/fees-payment.html')">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-translate="fees_payments">Fees & Payments</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">Management</div>
                    <a href="./modules/staff-payroll.html" class="menu-item" onclick="navigateToPage('./modules/staff-payroll.html')">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span data-translate="staff_payroll">Staff & Payroll</span>
                    </a>
                    <a href="./modules/procurement.html" class="menu-item" onclick="navigateToPage('./modules/procurement.html')">
                        <i class="fas fa-shopping-cart"></i>
                        <span data-translate="procurement">Procurement</span>
                    </a>
                </div>
                
                <div class="menu-section">
                    <div class="menu-section-title">System</div>
                    <a href="./modules/reports.html" class="menu-item" onclick="navigateToPage('./modules/reports.html')">
                        <i class="fas fa-chart-bar"></i>
                        <span data-translate="reports">Reports & Analytics</span>
                    </a>
                    <a href="./modules/settings.html" class="menu-item" onclick="navigateToPage('./modules/settings.html')">
                        <i class="fas fa-cog"></i>
                        <span data-translate="settings">Settings</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-home"></i>
                        <span data-translate="dashboard_title">Dashboard Overview</span>
                    </h1>
                </div>
                <div class="header-right">
                    <div class="language-toggle" onclick="toggleLanguage()">
                        <i class="fas fa-language"></i>
                        <span id="language-text">EN</span>
                    </div>
                    <div class="current-time">
                        <i class="fas fa-clock"></i>
                        <span id="current-time">Loading...</span>
                    </div>
                    <div class="user-profile" onclick="openUserProfileModal()">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="userName" class="user-name">Admin</span>
                    </div>
                    <button class="btn btn-danger logout-btn" onclick="confirmLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-translate="logout">Logout</span>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card" data-card="students" onclick="navigateToPage('./modules/student-module.html')">
                        <div class="card-icon students">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-translate="total_students">Total Students</h3>
                            <div class="card-value" id="totalStudents">1,254</div>
                            <div class="card-description positive">
                                <i class="fas fa-arrow-up"></i>
                                <span data-translate="students_growth">5.2% from last term</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card" data-card="fees" onclick="navigateToPage('./modules/fees-payment.html')">
                        <div class="card-icon fees">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-translate="fees_collected">Fees Collected</h3>
                            <div class="card-value" id="feesCollected">TZS 48.7M</div>
                            <div class="card-description">
                                <span class="positive" data-translate="fees_paid">TZS 32.1M Paid</span> â€¢ 
                                <span class="negative" data-translate="fees_due">TZS 16.6M Due</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card" data-card="payroll" onclick="navigateToPage('./modules/staff-payroll.html')">
                        <div class="card-icon payroll">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-translate="payroll">Payroll</h3>
                            <div class="card-value" id="payrollTotal">TZS 12.3M</div>
                            <div class="card-description">
                                <span class="negative" data-translate="payroll_pending">TZS 2.1M Pending</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card" data-card="procurement" onclick="navigateToPage('./modules/procurement.html')">
                        <div class="card-icon procurement">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="card-content">
                            <h3 data-translate="procurement">Procurement</h3>
                            <div class="card-value" id="procurementTotal">TZS 5.2M</div>
                            <div class="card-description">
                                <span class="positive" data-translate="requests_approved">3 Requests Approved</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2 data-translate="quick_actions">Quick Actions</h2>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="navigateToPage('./modules/student-module.html')">
                            <i class="fas fa-user-plus"></i>
                            <span data-translate="add_student">Add New Student</span>
                        </button>
                        <button class="action-btn" onclick="navigateToPage('./modules/fees-payment.html')">
                            <i class="fas fa-money-bill"></i>
                            <span data-translate="record_payment">Record Payment</span>
                        </button>
                        <button class="action-btn" onclick="navigateToPage('./modules/staff-payroll.html')">
                            <i class="fas fa-user-tie"></i>
                            <span data-translate="add_staff">Add Staff Member</span>
                        </button>
                        <button class="action-btn" onclick="navigateToPage('./modules/procurement.html')">
                            <i class="fas fa-shopping-cart"></i>
                            <span data-translate="new_purchase">New Purchase</span>
                        </button>
                        <button class="action-btn" onclick="navigateToPage('./modules/reports.html')">
                            <i class="fas fa-chart-line"></i>
                            <span data-translate="view_reports">View Reports</span>
                        </button>
                        <button class="action-btn" onclick="navigateToPage('./modules/settings.html')">
                            <i class="fas fa-cog"></i>
                            <span data-translate="system_settings">System Settings</span>
                        </button>
                    </div>
                </div>
                
                <!-- Analytics Chart -->
                <div class="analytics-section">
                    <div class="section-header">
                        <h2 data-translate="analytics">Analytics Overview</h2>
                        <button class="btn btn-secondary" onclick="toggleChart()" id="chartToggleBtn">
                            <i class="fas fa-eye-slash"></i>
                            <span data-translate="hide_chart">Hide Chart</span>
                        </button>
                    </div>
                    <div class="chart-container" id="chartContainer">
                        <canvas id="dashboardChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <div class="section-header">
                        <h2 data-translate="recent_activity">Recent Activity</h2>
                        <button class="btn btn-secondary" onclick="openModal('activitiesModal')">
                            <i class="fas fa-eye"></i>
                            <span data-translate="view_all">View All</span>
                        </button>
                    </div>
                    
                    <ul class="activity-list" id="activityList">
                        <li class="activity-item">
                            <div class="activity-icon payment">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title" data-translate="payment_activity">John Doe paid TZS 150,000 for Term 1 fees</div>
                                <div class="activity-time" id="activity1-time">Today at 10:30 AM</div>
                            </div>
                        </li>
                        
                        <li class="activity-item">
                            <div class="activity-icon salary">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title" data-translate="salary_activity">Salary processed for Mr. Johnson</div>
                                <div class="activity-time" id="activity2-time">Yesterday at 2:45 PM</div>
                            </div>
                        </li>
                        
                        <li class="activity-item">
                            <div class="activity-icon purchase">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title" data-translate="purchase_activity">New textbooks purchased for Form 5</div>
                                <div class="activity-time" id="activity3-time">September 10, 2025</div>
                            </div>
                        </li>
                        
                        <li class="activity-item">
                            <div class="activity-icon student">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title" data-translate="student_activity">New student enrolled: Mary Johnson</div>
                                <div class="activity-time" id="activity4-time">September 15, 2025</div>
                            </div>
                        </li>
                        
                        <li class="activity-item">
                            <div class="activity-icon staff">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title" data-translate="staff_activity">New teacher hired: Mr. Peter Mwangi</div>
                                <div class="activity-time" id="activity5-time">September 12, 2025</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- User Profile Modal -->
    <div id="userProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="user_profile">User Profile</h3>
                <button class="modal-close" onclick="closeModal('userProfileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" data-translate="full_name">Full Name</label>
                    <input type="text" class="form-control" id="userFullName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="email">Email</label>
                    <input type="email" class="form-control" id="userEmail" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="role">Role</label>
                    <input type="text" class="form-control" id="userRole" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" data-translate="username">Username</label>
                    <input type="text" class="form-control" id="userUsername" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Login Time</label>
                    <input type="text" class="form-control" id="userLoginTime" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteUserProfile()">
                    <i class="fas fa-trash"></i>
                    <span data-translate="delete">Delete</span>
                </button>
                <button class="btn btn-primary" onclick="updateUserProfile()">
                    <i class="fas fa-save"></i>
                    <span data-translate="update">Update</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="confirm_logout">Confirm Logout</h3>
                <button class="modal-close" onclick="closeModal('logoutModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p data-translate="logout_confirmation">Are you sure you want to logout?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logoutModal')">
                    <span data-translate="cancel">Cancel</span>
                </button>
                <button class="btn btn-danger" onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-translate="logout">Logout</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Activities Modal -->
    <div id="activitiesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="all_activities">All Activities</h3>
                <button class="modal-close" onclick="closeModal('activitiesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-translate="activity">Activity</th>
                            <th data-translate="type">Type</th>
                            <th data-translate="date">Date</th>
                            <th data-translate="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesTableBody">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLanguage = 'en';
        
        // Translation data
        const translations = {
            en: {
                dashboard_title: 'Dashboard Overview',
                dashboard: 'Dashboard',
                students: 'Students',
                fees_payments: 'Fees & Payments',
                staff_payroll: 'Staff & Payroll',
                procurement: 'Procurement',
                reports: 'Reports & Analytics',
                settings: 'Settings',
                total_students: 'Total Students',
                fees_collected: 'Fees Collected',
                payroll: 'Payroll',
                students_growth: '5.2% from last term',
                fees_paid: 'TZS 32.1M Paid',
                fees_due: 'TZS 16.6M Due',
                payroll_pending: 'TZS 2.1M Pending',
                requests_approved: '3 Requests Approved',
                quick_actions: 'Quick Actions',
                add_student: 'Add New Student',
                record_payment: 'Record Payment',
                add_staff: 'Add Staff Member',
                new_purchase: 'New Purchase',
                view_reports: 'View Reports',
                system_settings: 'System Settings',
                recent_activities: 'Recent Activities',
                view_all: 'View All',
                payment_activity: 'John Doe paid TZS 150,000 for Term 1 fees',
                salary_activity: 'Salary processed for Mr. Johnson',
                purchase_activity: 'New textbooks purchased for Form 5',
                student_activity: 'New student enrolled: Mary Johnson',
                staff_activity: 'New teacher hired: Mr. Peter Mwangi',
                user_profile: 'User Profile',
                full_name: 'Full Name',
                email: 'Email',
                role: 'Role',
                delete: 'Delete',
                update: 'Update',
                confirm_logout: 'Confirm Logout',
                logout_confirmation: 'Are you sure you want to logout?',
                cancel: 'Cancel',
                logout: 'Logout',
                all_activities: 'All Activities',
                activity: 'Activity',
                type: 'Type',
                date: 'Date',
                actions: 'Actions'
            },
            sw: {
                dashboard_title: 'Muhtasari wa Dashibodi',
                dashboard: 'Dashibodi',
                students: 'Wanafunzi',
                fees_payments: 'Ada na Malipo',
                staff_payroll: 'Wafanyakazi na Mishahara',
                procurement: 'Ununuzi',
                reports: 'Ripoti na Takwimu',
                settings: 'Mipangilio',
                total_students: 'Wanafunzi Wote',
                fees_collected: 'Ada Zilizokusanywa',
                payroll: 'Malipo ya Mshahara',
                students_growth: '5.2% kutoka muhula uliopita',
                fees_paid: 'TZS 32.1M Imelipwa',
                fees_due: 'TZS 16.6M Inayotakiwa',
                payroll_pending: 'TZS 2.1M Inasubiri',
                requests_approved: 'Maombi 3 Yamekubaliwa',
                quick_actions: 'Vitendo vya Haraka',
                add_student: 'Ongeza Mwanafunzi Mpya',
                record_payment: 'Rekodi Malipo',
                add_staff: 'Ongeza Mfanyakazi',
                new_purchase: 'Ununuzi Mpya',
                view_reports: 'Ona Ripoti',
                system_settings: 'Mipangilio ya Mfumo',
                recent_activities: 'Shughuli za Hivi Karibuni',
                view_all: 'Ona Zote',
                payment_activity: 'John Doe alilipa TZS 150,000 kwa ada za Muhula 1',
                salary_activity: 'Mshahara wa Bw. Johnson umetolewa',
                purchase_activity: 'Vitabu vipya vimenunuliwa kwa Kidato cha 5',
                student_activity: 'Mwanafunzi mpya ameandikishwa: Mary Johnson',
                staff_activity: 'Mwalimu mpya ameajiriwa: Bw. Peter Mwangi',
                user_profile: 'Wasifu wa Mtumiaji',
                full_name: 'Jina Kamili',
                email: 'Barua pepe',
                role: 'Jukumu',
                delete: 'Futa',
                update: 'Sasisha',
                confirm_logout: 'Thibitisha Kutoka',
                logout_confirmation: 'Una uhakika unataka kutoka?',
                cancel: 'Ghairi',
                logout: 'Toka',
                all_activities: 'Shughuli Zote',
                activity: 'Shughuli',
                type: 'Aina',
                date: 'Tarehe',
                actions: 'Vitendo'
            }
        };

        // Update current time
        function updateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('current-time').textContent = now.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'sw-TZ', options);
        }
        
        setInterval(updateTime, 1000);
        updateTime();

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggleIcon = document.querySelector('.sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-bars';
            } else {
                toggleIcon.className = 'fas fa-times';
            }
        }

        // Language toggle functionality
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'sw' : 'en';
            const languageText = document.getElementById('language-text');
            languageText.textContent = currentLanguage.toUpperCase();
            
            // Update all translatable elements
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
            
            // Update time format
            updateTime();
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // User profile functions
        function openUserProfileModal() {
            const user = window.authManager.getCurrentUser();
            const session = window.authManager.getSession();
            
            if (user && session) {
                document.getElementById('userFullName').value = user.fullName;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userLoginTime').value = new Date(session.loginTime).toLocaleString();
            }
            
            openModal('userProfileModal');
        }

        function updateUserProfile() {
            // Profile is read-only in this version
            closeModal('userProfileModal');
            showNotification('Profile information is managed by the system administrator', 'info');
        }

        function deleteUserProfile() {
            closeModal('userProfileModal');
            confirmLogout();
        }

        // Logout functions
        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                showNotification('Logging out...', 'info');
                setTimeout(() => {
                    window.authManager.logout();
                }, 1000);
            }
        }

        // Legacy logout functions (kept for compatibility)
        function openLogoutModal() {
            confirmLogout();
        }

        // Activities functions
        function openActivitiesModal() {
            const tableBody = document.getElementById('activitiesTableBody');
            const activities = [
                {
                    activity: currentLanguage === 'en' ? 'John Doe paid TZS 150,000 for Term 1 fees' : 'John Doe alilipa TZS 150,000 kwa ada za Muhula 1',
                    type: currentLanguage === 'en' ? 'Payment' : 'Malipo',
                    date: 'Today at 10:30 AM'
                },
                {
                    activity: currentLanguage === 'en' ? 'Salary processed for Mr. Johnson' : 'Mshahara wa Bw. Johnson umetolewa',
                    type: currentLanguage === 'en' ? 'Salary' : 'Mshahara',
                    date: 'Yesterday at 2:45 PM'
                },
                {
                    activity: currentLanguage === 'en' ? 'New textbooks purchased for Form 5' : 'Vitabu vipya vimenunuliwa kwa Kidato cha 5',
                    type: currentLanguage === 'en' ? 'Purchase' : 'Ununuzi',
                    date: 'September 10, 2025'
                },
                {
                    activity: currentLanguage === 'en' ? 'New student enrolled: Mary Johnson' : 'Mwanafunzi mpya ameandikishwa: Mary Johnson',
                    type: currentLanguage === 'en' ? 'Student' : 'Mwanafunzi',
                    date: 'September 15, 2025'
                },
                {
                    activity: currentLanguage === 'en' ? 'New teacher hired: Mr. Peter Mwangi' : 'Mwalimu mpya ameajiriwa: Bw. Peter Mwangi',
                    type: currentLanguage === 'en' ? 'Staff' : 'Mfanyakazi',
                    date: 'September 12, 2025'
                }
            ];
            
            tableBody.innerHTML = activities.map(activity => `
                <tr>
                    <td>${activity.activity}</td>
                    <td>${activity.type}</td>
                    <td>${activity.date}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editActivity(${activities.indexOf(activity)})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteActivity(${activities.indexOf(activity)})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            openModal('activitiesModal');
        }

        function editActivity(index) {
            showNotification('Activity updated successfully', 'success');
        }

        function deleteActivity(index) {
            showNotification('Activity deleted successfully', 'success');
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}"></i>
                </div>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Chart variables
        let dashboardChart = null;
        let chartVisible = true;

        // Initialize chart
        function initializeChart() {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (dashboardChart) {
                dashboardChart.destroy();
            }
            
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [
                        {
                            label: 'Students Enrolled',
                            data: [1200, 1250, 1300, 1280, 1350, 1400, 1450, 1500, 1520, 1550, 1580, 1600],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Fees Collection (TZS Millions)',
                            data: [45, 48, 52, 50, 55, 58, 60, 62, 65, 68, 70, 72],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Staff Count',
                            data: [85, 87, 90, 88, 92, 95, 98, 100, 102, 105, 108, 110],
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#4361ee',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Toggle chart visibility
        function toggleChart() {
            const chartContainer = document.getElementById('chartContainer');
            const toggleBtn = document.getElementById('chartToggleBtn');
            const icon = toggleBtn.querySelector('i');
            const text = toggleBtn.querySelector('span');
            
            chartVisible = !chartVisible;
            
            if (chartVisible) {
                chartContainer.classList.remove('hidden');
                icon.className = 'fas fa-eye-slash';
                text.textContent = 'Hide Chart';
                text.setAttribute('data-translate', 'hide_chart');
                
                // Reinitialize chart when showing
                setTimeout(() => {
                    initializeChart();
                }, 300);
            } else {
                chartContainer.classList.add('hidden');
                icon.className = 'fas fa-eye';
                text.textContent = 'Show Chart';
                text.setAttribute('data-translate', 'show_chart');
                
                // Destroy chart when hiding to free memory
                if (dashboardChart) {
                    dashboardChart.destroy();
                    dashboardChart = null;
                }
            }
            
            // Save preference
            localStorage.setItem('chartVisible', chartVisible);
        }

        // Load chart preference
        function loadChartPreference() {
            const savedPreference = localStorage.getItem('chartVisible');
            if (savedPreference !== null) {
                chartVisible = JSON.parse(savedPreference);
                if (!chartVisible) {
                    toggleChart();
                }
            }
        }

        // Dashboard data loading
        let dashboardData = {
            students: { total: 0, growth: '0%' },
            fees: { collected: 0, due: 0, paid: '0%' },
            payroll: { total: 0, pending: 0 },
            procurement: { requests: 0, approved: 0 }
        };

        // Load dashboard statistics from API
        async function loadDashboardStats() {
            try {
                showLoading(true);
                
                const response = await window.apiClient.getDashboardStats();
                
                if (response.success && response.data) {
                    const data = response.data;
                    
                    // Update overview cards
                    updateSummaryCard('students', data.overview.total_students || 0);
                    updateSummaryCard('fees', data.financial.total_fees_collected_ytd || 0);
                    updateSummaryCard('payroll', data.financial.total_payroll_ytd || 0);
                    updateSummaryCard('procurement', data.financial.total_procurement_ytd || 0);
                    
                    // Update chart with real data
                    if (data.monthly_trends) {
                        updateChartWithRealData(data.monthly_trends);
                    }
                    
                    // Update recent activities
                    if (data.recent_activities) {
                        updateRecentActivities(data.recent_activities);
                    }
                    
                    dashboardData = data;
                }
                
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
                showNotification('Failed to load dashboard data. Using demo data.', 'warning');
                // Keep existing demo data
            } finally {
                showLoading(false);
            }
        }

        // Update summary card values
        function updateSummaryCard(type, value) {
            let cardElement, formattedValue;
            
            switch (type) {
                case 'students':
                    cardElement = document.querySelector('[data-card="students"] .card-value');
                    formattedValue = value.toLocaleString();
                    break;
                    
                case 'fees':
                    cardElement = document.querySelector('[data-card="fees"] .card-value');
                    formattedValue = `TZS ${(value / 1000000).toFixed(1)}M`;
                    break;
                    
                case 'payroll':
                    cardElement = document.querySelector('[data-card="payroll"] .card-value');
                    formattedValue = `TZS ${(value / 1000000).toFixed(1)}M`;
                    break;
                    
                case 'procurement':
                    cardElement = document.querySelector('[data-card="procurement"] .card-value');
                    formattedValue = `TZS ${(value / 1000000).toFixed(1)}M`;
                    break;
            }
            
            if (cardElement) {
                cardElement.textContent = formattedValue;
            }
        }

        // Update chart with real API data
        function updateChartWithRealData(monthlyTrends) {
            if (!dashboardChart) return;
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Process fees collection data
            const feesData = new Array(12).fill(0);
            if (monthlyTrends.fees_collection) {
                monthlyTrends.fees_collection.forEach(item => {
                    const monthIndex = parseInt(item.month) - 1;
                    if (monthIndex >= 0 && monthIndex < 12) {
                        feesData[monthIndex] = parseFloat(item.total) / 1000000; // Convert to millions
                    }
                });
            }
            
            // Process payroll data
            const payrollData = new Array(12).fill(0);
            if (monthlyTrends.payroll_expenses) {
                monthlyTrends.payroll_expenses.forEach(item => {
                    const monthIndex = parseInt(item.month) - 1;
                    if (monthIndex >= 0 && monthIndex < 12) {
                        payrollData[monthIndex] = parseFloat(item.total) / 1000000; // Convert to millions
                    }
                });
            }
            
            // Process procurement data
            const procurementData = new Array(12).fill(0);
            if (monthlyTrends.procurement_spending) {
                monthlyTrends.procurement_spending.forEach(item => {
                    const monthIndex = parseInt(item.month) - 1;
                    if (monthIndex >= 0 && monthIndex < 12) {
                        procurementData[monthIndex] = parseFloat(item.total) / 1000000; // Convert to millions
                    }
                });
            }
            
            // Update chart data
            dashboardChart.data.datasets[0].data = [1200, 1250, 1300, 1280, 1350, 1400, 1450, 1500, 1520, 1550, 1580, 1600]; // Keep demo student data for now
            dashboardChart.data.datasets[1].data = feesData;
            dashboardChart.data.datasets[2].data = payrollData;
            
            dashboardChart.update();
        }

        // Update recent activities with real data
        function updateRecentActivities(activities) {
            const activityList = document.querySelector('.activity-list');
            if (!activityList || !activities) return;
            
            let activityItems = [];
            
            // Add recent payments
            if (activities.recent_payments) {
                activities.recent_payments.slice(0, 3).forEach(payment => {
                    activityItems.push({
                        icon: 'payment',
                        iconClass: 'fas fa-money-bill-wave',
                        title: `${payment.student_name} paid TZS ${parseFloat(payment.amount).toLocaleString()} for ${payment.fee_type}`,
                        time: formatRelativeTime(payment.payment_date)
                    });
                });
            }
            
            // Add recent purchase orders
            if (activities.recent_purchase_orders) {
                activities.recent_purchase_orders.slice(0, 2).forEach(po => {
                    activityItems.push({
                        icon: 'purchase',
                        iconClass: 'fas fa-shopping-cart',
                        title: `Purchase Order ${po.po_number} created for ${po.supplier_name}`,
                        time: formatRelativeTime(po.created_at)
                    });
                });
            }
            
            // Update activity list HTML
            activityList.innerHTML = activityItems.map(activity => `
                <li class="activity-item">
                    <div class="activity-icon ${activity.icon}">
                        <i class="${activity.iconClass}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-time">${activity.time}</div>
                    </div>
                </li>
            `).join('');
        }

        // Format relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) {
                return 'Just now';
            } else if (diffInHours < 24) {
                return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
            } else {
                const diffInDays = Math.floor(diffInHours / 24);
                return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            }
        }

        // Show/hide loading state
        function showLoading(show) {
            const summaryCards = document.querySelectorAll('.summary-card');
            summaryCards.forEach(card => {
                if (show) {
                    card.classList.add('loading');
                } else {
                    card.classList.remove('loading');
                }
            });
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Load user preferences
            loadUserPreferences();
            loadChartPreference();
            
            // Initialize chart
            setTimeout(() => {
                if (chartVisible) {
                    initializeChart();
                }
            }, 1000);
            
            // Load real dashboard data
            setTimeout(() => {
                loadDashboardStats();
            }, 1500);
            
            // Initialize activity list
            loadRecentActivities();
            
            showNotification('Welcome to School Management System!', 'success');
        });
    </script>
</body>
</html>